<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interface Example</title>
<style>
    .container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding: 20px;
    }
    .box {
        border: 1px solid #000;
        padding: 10px;
        flex-basis: calc(33% - 20px);
        box-sizing: border-box;
    }
    .box h2 {
        font-size: 20px;
        border-bottom: 1px solid #000;
        margin-bottom: 10px;
    }
    .box input, .box select {
        width: 100%;
        padding: 5px;
        margin-bottom: 10px;
    }
    .label-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    .label-row label {
        flex-basis: 50%;
        margin-right: 10px;
    }
    .label-row input, .label-row select {
        flex-basis: calc(50% - 10px);
    }
    iframe {
        width: 100%;
        height: 500px;
        border: none;
    }
</style>
</head>
<body>
    <div class="container">
        <div class="box">
            <h2>Initialize Model</h2>
            <div class="label-row">
                <label for="width">Width:</label>
                <input type="number" id="width" value="10">
            </div>
            <div class="label-row">
                <label for="height">Height:</label>
                <input type="number" id="height" value="10">
            </div>
            <div class="label-row">
                <label for="day_night_cycle">Day Night Cycle:</label>
                <input type="number" id="day_night_cycle" value="24">
            </div>
            <button onclick="initializeModel()">Initialize Model</button>
        </div>

        <div class="box">
            <h2>Step Model</h2>
            <div class="label-row">
                <label for="current_step">Current Step:</label>
                <input type="text" id="current_step" name="current_step" disabled>
            </div>
            <button onclick="stepModel()">Step Model</button>
            <button onclick="startAutoStep()">Start Auto Step</button>
            <button onclick="stopAutoStep()">Stop Auto Step</button>
        </div>

        <div class="box">
            <h2>Individual Factors</h2>
            <div class="label-row">
                <label for="preferred_temperature">Preferred Temperature:</label>
                <input type="number" id="preferred_temperature" name="preferred_temperature" value="37">
            </div>
            <div class="label-row">
                <label for="preferred_light">Preferred Light:</label>
                <input type="number" id="preferred_light" name="preferred_light" value="80">
            </div>
            <div class="label-row">
                <label for="preferred_acoustics">Preferred Acoustics:</label>
                <input type="number" id="preferred_acoustics" name="preferred_acoustics" value="37">
            </div>
            <div class="label-row">
                <label for="preferred_air_quality">Preferred Air Quality:</label>
                <input type="number" id="preferred_air_quality" name="preferred_air_quality" value="70">
            </div>
        </div>

        <div class="box">
            <h2>Indoor Environmental Conditions</h2>
            <div class="label-row">
                <label for="view">View:</label>
                <select id="view" name="view" disabled>
                    <option value="no_view">No View</option>
                    <option value="view">View</option>
                </select>
            </div>
            <div class="label-row">
                <label for="temperature">Temperature:</label>
                <input type="number" id="temperature" name="temperature" value="71" disabled>
            </div>
            <div class="label-row">
                <label for="light">Light:</label>
                <input type="number" id="light" name="light" value="190" disabled>
            </div>
            <div class="label-row">
                <label for="acoustics">Acoustics:</label>
                <input type="number" id="acoustics" name="acoustics" value="37.5" disabled>
            </div>
            <div class="label-row">
                <label for="air_quality">Air Quality:</label>
                <input type="number" id="air_quality" name="air_quality" value="500" disabled>
            </div>
        </div>

        <div class="box">
            <h2>Passive Systems</h2>
            <div class="label-row">
                <label for="windowStatus">Window Status:</label>
                <input type="text" id="windowStatus" name="windowStatus" disabled>
            </div>
            
            <div class="label-row">
                <label for="blindStatus">Blind Status:</label>
                <input type="text" id="blindStatus" name="blindStatus" disabled>
            </div>
        </div>

        <div class="box">
            <h2>Window Beliefs</h2>
            <div class="label-row">
                <label for="window_temperature">Adjusting Window Temperature:</label>
                <select id="window_temperature" name="window_temperature">
                    <option value="improve">Improve</option>
                </select>
            </div>
            <div class="label-row">
                <label for="window_air_quality">Adjusting Window Air Quality:</label>
                <select id="window_air_quality" name="window_air_quality">
                    <option value="improve">Improve</option>
                </select>
            </div>
            <div class="label-row">
                <label for="window_acoustics">Adjusting Window Acoustics:</label>
                <select id="window_acoustics" name="window_acoustics">
                    <option value="improve">Improve</option>
                </select>
            </div>
        </div>

        <div class="box">
            <h2>Window TBP Conditions</h2>
            <div class="label-row">
                <label for="window_attitude">Window Attitude:</label>
                <input type="number" id="window_attitude" name="window_attitude" value="3">
            </div>
            <div class="label-row">
                <label for="window_perceived_norm">Window Perceived Norm:</label>
                <input type="number" id="window_perceived_norm" name="window_perceived_norm" value="5">
            </div>
            <div class="label-row">
                <label for="window_perceived_behavioral_conditions">Window Perceived Behavioral Conditions:</label>
                <input type="number" id="window_perceived_behavioral_conditions" name="window_perceived_behavioral_conditions" value="5">
            </div>
            <div class="label-row">
                <label for="window_intention">Window Intention:</label>
                <input type="number" id="window_intention" name="window_intention" value="5" disabled>
            </div>
        </div>

        <div class="box">
            <h2>Active Systems</h2>
            <div class="label-row">
                <label for="airConditionStatus">Air Condition Status:</label>
                <input type="text" id="airConditionStatus" name="airConditionStatus" disabled>
            </div>
            <div class="label-row">
                <label for="artificialLightStatus">Artificial Light Status:</label>
                <input type="text" id="artificialLightStatus" name="artificialLightStatus" disabled>
            </div>
        </div>

        <div class="box">
            <h2>Blind Beliefs</h2>
            <div class="label-row">
                <label for="blind_temperature">Adjusting Blind Temperature:</label>
                <select id="blind_temperature" name="blind_temperature">
                    <option value="improve">Improve</option>
                </select>
            </div>
            <div class="label-row">
                <label for="blind_air_quality">Adjusting Blind Air Quality:</label>
                <select id="blind_air_quality" name="blind_air_quality">
                    <option value="improve">Improve</option>
                </select>
            </div>
            <div class="label-row">
                <label for="blind_acoustics">Adjusting Blind Acoustics:</label>
                <select id="blind_acoustics" name="blind_acoustics">
                    <option value="improve">Improve</option>
                </select>
            </div>
        </div>

        <div class="box">
            <h2>Blind TBP Conditions</h2>
            <div class="label-row">
                <label for="blind_attitude">Blind Attitude:</label>
                <input type="number" id="blind_attitude" name="blind_attitude" value="3">
            </div>
            <div class="label-row">
                <label for="blind_perceived_norm">Blind Perceived Norm:</label>
                <input type="number" id="blind_perceived_norm" name="blind_perceived_norm" value="5">
            </div>
            <div class="label-row">
                <label for="blind_perceived_behavioral_conditions">Blind Perceived Behavioral Conditions:</label>
                <input type="number" id="blind_perceived_behavioral_conditions" name="blind_perceived_behavioral_conditions" value="5">
            </div>
            <div class="label-row">
                <label for="blind_intention">Blind Intention:</label>
                <input type="number" id="blind_intention" name="blind_intention" value="5" disabled>
            </div>
        </div>

        <div class="box" style="flex-basis: 100%;">
            <h2>Mesa Visualization</h2>
            <iframe src="http://127.0.0.1:8521/" id="mesa-iframe"></iframe>
        </div>
    </div>

    <script>
        let autoStepInterval;

        async function initializeModel() {
            const width = parseInt(document.getElementById('width').value, 10);
            const height = parseInt(document.getElementById('height').value, 10);
            const dayNightCycle = parseInt(document.getElementById('day_night_cycle').value, 10);
            const preferredTemperature = parseInt(document.getElementById('preferred_temperature').value, 10);
            const preferredLight = parseInt(document.getElementById('preferred_light').value, 10);
            const preferredAcoustics = parseInt(document.getElementById('preferred_acoustics').value, 10);
            const preferredAirQuality = parseInt(document.getElementById('preferred_air_quality').value, 10);
            const blindAttitude = parseInt(document.getElementById('blind_attitude').value);
            const blindPerceivedNorm = parseInt(document.getElementById('blind_perceived_norm').value);
            const blindPerceivedBehavioralControl = parseInt(document.getElementById('blind_perceived_behavioral_conditions').value);
            const windowAttitude = parseInt(document.getElementById('window_attitude').value);
            const windowPerceivedNorm = parseInt(document.getElementById('window_perceived_norm').value);
            const windowPerceivedBehavioralConditions = parseInt(document.getElementById('window_perceived_behavioral_conditions').value);


            const config = {
                width: parseInt(width, 10),
                height: parseInt(height, 10),
                day_night_cycle: parseInt(dayNightCycle, 10),
                preferences: {
                    preferred_temperature: preferredTemperature,
                    preferred_light: preferredLight,
                    preferred_acoustics: preferredAcoustics,
                    preferred_air_quality: preferredAirQuality,
                    blind_attitude: blindAttitude,
                    blind_perceived_norm: blindPerceivedNorm,
                    blind_perceived_behavioral_conditions: blindPerceivedBehavioralControl,
                    window_attitude: windowAttitude,
                    window_perceived_norm: windowPerceivedNorm,
                    window_perceived_behavioral_conditions: windowPerceivedBehavioralConditions
                }
            };

            console.log("Sending initialize request:", config);

            const response = await fetch('/initialize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });

            const result = await response.json();
            console.log("Initialize response:", result);
            alert(result.message);

            // Fetch and display environmental conditions after initialization
            fetchConditions();
        }

        async function stepModel() {
            console.log("Sending step request");

            const response = await fetch('/step', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const agents = await response.json();
            console.log("Step response:", agents);

            // Fetch and display updated environmental conditions after each step
            fetchConditions();
        }

        function startAutoStep() {
            if (!autoStepInterval) {
                autoStepInterval = setInterval(stepModel, 1000); // Step every second
            }
        }

        function stopAutoStep() {
            if (autoStepInterval) {
                clearInterval(autoStepInterval);
                autoStepInterval = null;
            }
        }

        async function fetchConditions() {
            const response = await fetch('/get_conditions', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });

            const conditions = await response.json();
            console.log("Fetched conditions:", conditions);

            if (conditions.error) {
                console.error(conditions.error);
                return;
            }

            document.getElementById('view').value = conditions.view;
            document.getElementById('temperature').value = conditions.temperature;
            document.getElementById('light').value = conditions.light;
            document.getElementById('acoustics').value = conditions.acoustics;
            document.getElementById('air_quality').value = conditions.air_quality;
            document.getElementById('windowStatus').value = conditions.windowStatus;
            document.getElementById('blindStatus').value = conditions.blindStatus;
            document.getElementById('window_intention').value = conditions.window_intention;
            document.getElementById('blind_intention').value = conditions.blind_intention;
            document.getElementById('artificialLightStatus').value = conditions.artificialLightStatus;
            document.getElementById('airConditionStatus').value = conditions.airConditionStatus;
            document.getElementById('windowStatus').value = conditions.windowStatus;
            document.getElementById('current_step').value = conditions.current_step;
        }

        // Fetch conditions on page load
        window.onload = fetchConditions;
    </script>
</body>
</html>
